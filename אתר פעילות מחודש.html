<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NFC Kids Portal</title>
  <style>
    :root{
      --bg:#0b1220; --card:#101a33; --muted:#8ea2c6; --text:#eaf0ff;
      --accent:#6ee7ff; --accent2:#a78bfa; --danger:#ff6b6b; --ok:#34d399;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Hebrew", sans-serif;
      background: radial-gradient(900px 600px at 80% -10%, rgba(167,139,250,.20), transparent 60%),
                  radial-gradient(900px 600px at 10% 0%, rgba(110,231,255,.18), transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding: 18px;
    }
    .app{width: min(980px, 100%); display:grid; gap:14px;}
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      background: rgba(16,26,51,.75);
      border: 1px solid rgba(142,162,198,.18);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    header .title{display:flex; gap:10px; align-items:center;}
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(142,162,198,.22);
      background: rgba(14,21,43,.7);
      color: var(--muted);
    }
    .btn, button{
      cursor:pointer;
      border: 1px solid rgba(142,162,198,.22);
      background: rgba(14,21,43,.75);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      transition: transform .05s ease, border-color .2s ease, background .2s ease;
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
    }
    .btn:hover{border-color: rgba(110,231,255,.55)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(110,231,255,.18), rgba(167,139,250,.18));
      border-color: rgba(110,231,255,.35);
    }
    .btn.danger{border-color: rgba(255,107,107,.45); background: rgba(255,107,107,.10)}
    .btn.ok{border-color: rgba(52,211,153,.45); background: rgba(52,211,153,.10)}
    .icon-btn{
      width:44px; height:44px; display:grid; place-items:center;
      border-radius: 14px;
    }
    .right-actions{display:flex; gap:10px; align-items:center}
    main{
      display:grid; gap:14px;
      grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width: 860px){
      main{grid-template-columns: 1fr}
    }
    .card{
      background: rgba(16,26,51,.72);
      border: 1px solid rgba(142,162,198,.18);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    h1,h2,h3{margin:0 0 10px 0}
    h1{font-size:18px}
    h2{font-size:16px; color: var(--text)}
    p{margin: 8px 0; color: var(--muted); line-height:1.5}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:520px){.grid2{grid-template-columns:1fr}}
    input, select{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(142,162,198,.22);
      background: rgba(10,16,34,.6);
      color: var(--text);
      outline:none;
    }
    input::placeholder{color: rgba(142,162,198,.75)}
    .muted{color: var(--muted); font-size: 12px}
    .big{font-size: 24px; letter-spacing: .2px; margin: 0 0 6px 0;}
    .divider{height:1px; background: rgba(142,162,198,.16); margin: 12px 0;}
    .list{display:grid; gap:10px}
    .item{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(142,162,198,.18);
      background: rgba(10,16,34,.35);
      display:flex; justify-content:space-between; gap:12px; align-items:center;
    }
    .item strong{font-size:14px}
    .badge{
      font-size:12px; padding: 6px 10px; border-radius: 999px;
      border:1px solid rgba(142,162,198,.22);
      color: var(--muted);
      background: rgba(14,21,43,.55);
      white-space:nowrap;
    }
    .status{
      font-size:12px; padding: 8px 10px; border-radius: 14px;
      border: 1px solid rgba(142,162,198,.22);
      background: rgba(10,16,34,.35);
      color: var(--muted);
    }
    .status.ok{border-color: rgba(52,211,153,.40); color: rgba(170,255,220,.95)}
    .status.bad{border-color: rgba(255,107,107,.40); color: rgba(255,190,190,.95)}
    .hidden{display:none !important}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .note{font-size:12px; color: rgba(142,162,198,.9)}
    .k{color: var(--text)}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <div style="width:38px;height:38px;border-radius:14px;display:grid;place-items:center;background:rgba(110,231,255,.14);border:1px solid rgba(110,231,255,.30)">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M7 7c6 0 10 4 10 10" stroke="rgba(110,231,255,.95)" stroke-width="2" stroke-linecap="round"/>
            <path d="M7 11c4 0 6 2 6 6" stroke="rgba(167,139,250,.95)" stroke-width="2" stroke-linecap="round"/>
            <path d="M7 15c2 0 2 0 2 2" stroke="rgba(234,240,255,.95)" stroke-width="2" stroke-linecap="round"/>
            <path d="M4 4v16" stroke="rgba(142,162,198,.85)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <h1 style="margin:0">NFC ילדים — פורטל נקודות ופרסים</h1>
            <span id="modePill" class="pill">מצב: בית</span>
          </div>
          <div class="muted">תצוגה מקדימה: דמו בדפדפן עם שמירה ב־LocalStorage</div>
        </div>
      </div>

      <div class="right-actions">
        <button id="goHomeBtn" class="btn">בית</button>
        <button id="settingsBtn" class="icon-btn btn" title="הגדרות">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="rgba(234,240,255,.95)" stroke-width="2"/>
            <path d="M19.4 15a8.2 8.2 0 0 0 .1-1l2-1.2-2-3.5-2.3.7a7.6 7.6 0 0 0-1.7-1l-.3-2.4H9.8l-.3 2.4a7.6 7.6 0 0 0-1.7 1l-2.3-.7-2 3.5 2 1.2a8.2 8.2 0 0 0 .1 1 8.2 8.2 0 0 0-.1 1l-2 1.2 2 3.5 2.3-.7a7.6 7.6 0 0 0 1.7 1l.3 2.4h4.4l.3-2.4a7.6 7.6 0 0 0 1.7-1l2.3.7 2-3.5-2-1.2a8.2 8.2 0 0 0-.1-1Z" stroke="rgba(142,162,198,.85)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </header>

    <main>
      <section class="card" id="screenContainer">

        <!-- HOME -->
        <div id="homeScreen">
          <h2>מסך בית</h2>
          <p class="big">יש לשים כרטיס מאחורי הטלפון כדי להתחיל</p>

          <div class="row">
            <button id="startScanBtn" class="btn primary">התחל סריקה (NFC)</button>
            <button id="demoUidBtn" class="btn">סריקה דוגמה</button>
          </div>

          <div class="divider"></div>

          <div class="grid2">
            <div>
              <label class="muted">סימולציה: הזן UID ידני</label>
              <input id="uidInput" class="mono" placeholder="למשל: 04AABBCC1122" />
              <div class="row" style="margin-top:10px">
                <button id="scanUidBtn" class="btn ok">בדוק UID</button>
                <button id="clearUidBtn" class="btn">נקה</button>
              </div>
              <p class="note">אם Web NFC נתמך, כפתור הסריקה ינסה לקרוא תג אמיתי (Android/Chrome/HTTPS בדרך כלל).</p>
            </div>
            <div>
              <div id="scanStatus" class="status">סטטוס: מוכן</div>
              <p class="muted">תוצאה אחרי סריקה: ילד נמצא / לא נמצא.</p>
              <div class="divider"></div>
              <div class="muted">ילדים שמוגדרים כרגע:</div>
              <div id="kidsMiniList" class="list" style="margin-top:10px"></div>
            </div>
          </div>
        </div>

        <!-- KID PORTAL -->
        <div id="kidPortalScreen" class="hidden">
          <div class="row" style="justify-content:space-between">
            <div>
              <h2>פורטאל אישי — <span id="kidNameTitle"></span></h2>
              <div class="muted">UID: <span id="kidUidTitle" class="mono"></span></div>
            </div>
            <button id="backToHomeBtn" class="btn">חזרה לבית</button>
          </div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between">
            <div>
              <div class="muted">נקודות</div>
              <div id="kidPoints" class="big">0</div>
            </div>
            <div class="badge">מסך ילדים: קנייה בלבד</div>
          </div>

          <div class="divider"></div>

          <h3>חנות פרסים</h3>
          <p class="muted">אפשר לקנות רק אם יש מספיק נקודות. אחרת הפרס “נעול”.</p>
          <div id="prizesStoreList" class="list"></div>
        </div>

        <!-- SETTINGS (Admin inside) -->
        <div id="settingsScreen" class="hidden">
          <div class="row" style="justify-content:space-between">
            <h2>הגדרות</h2>
            <button id="closeSettingsBtn" class="btn">סגור</button>
          </div>

          <div id="settingsLocked">
            <p class="muted">כדי להמשיך יש להזין קוד.</p>
            <label class="muted">קוד</label>
            <input id="settingsPassword" type="password" placeholder="••••" inputmode="numeric" />
            <div class="row" style="margin-top:10px">
              <button id="unlockSettingsBtn" class="btn primary">אישור</button>
              <span id="settingsMsg" class="status hidden"></span>
            </div>
          </div>

          <div id="settingsUnlocked" class="hidden">
            <div class="status ok">מצב מנהל פתוח ✅</div>

            <div class="divider"></div>

            <h3>ניהול קודי כניסה</h3>
            <p class="muted">אפשר להוסיף עוד קודים. (הקודים נשמרים במכשיר הזה בלבד)</p>
            <div class="grid2">
              <div>
                <label class="muted">קוד חדש</label>
                <input id="newAdminCode" type="password" placeholder="••••" inputmode="numeric" />
                <div class="row" style="margin-top:10px">
                  <button id="addAdminCodeBtn" class="btn ok">הוסף קוד</button>
                </div>
              </div>
              <div>
                <div class="muted">קודים קיימים:</div>
                <div id="adminCodesList" class="list" style="margin-top:10px"></div>
              </div>
            </div>

            <div class="divider"></div>

            <h3>בחירת ילד</h3>
            <p class="muted">לחץ על שם של ילד כדי לערוך נקודות.</p>
            <div id="adminKidsPicker" class="list"></div>

            <div id="adminKidEditor" class="hidden">
              <div class="divider"></div>

              <div class="row" style="justify-content:space-between; align-items:flex-end">
                <div>
                  <h3 style="margin:0">עריכת נקודות — <span id="adminKidName"></span></h3>
                  <div class="muted">UID: <span id="adminKidUid" class="mono"></span></div>
                </div>
                <div>
                  <div class="muted">נקודות נוכחיות</div>
                  <div id="adminKidPoints" class="big">0</div>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px">
                <div>
                  <label class="muted">הוסף נקודות</label>
                  <input id="addPoints" type="number" min="0" placeholder="למשל: 10" />
                  <div class="row" style="margin-top:10px">
                    <button id="addPointsBtn" class="btn ok">הוסף</button>
                  </div>
                </div>
                <div>
                  <label class="muted">הורד נקודות</label>
                  <input id="removePoints" type="number" min="0" placeholder="למשל: 5" />
                  <div class="row" style="margin-top:10px">
                    <button id="removePointsBtn" class="btn danger">הורד</button>
                    <button id="setZeroBtn" class="btn danger">אפס</button>
                  </div>
                </div>
              </div>

              <div class="divider"></div>

              <h3>היסטוריית קניות</h3>
              <div id="purchaseHistory" class="list"></div>
            </div>

            <div class="divider"></div>

            <h3>ניהול ילדים</h3>
            <div class="grid2">
              <div>
                <label class="muted">שם הילד</label>
                <input id="newKidName" placeholder="למשל: דותן" />
              </div>
              <div>
                <label class="muted">UID של הכרטיס</label>
                <input id="newKidUid" class="mono" placeholder="למשל: 04AABBCC1122" />
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <button id="addKidBtn" class="btn ok">הוסף ילד</button>
              <button id="exportBtn" class="btn">ייצוא</button>
              <button id="importBtn" class="btn">ייבוא</button>
              <input id="importFile" type="file" accept="application/json" class="hidden" />
              <button id="resetDemoDataBtn" class="btn danger">איפוס נתונים</button>
            </div>

            <div class="divider"></div>

            <div class="muted">רשימת ילדים:</div>
            <div id="kidsAdminList" class="list" style="margin-top:10px"></div>

            <div class="divider"></div>

            <h3>ניהול פרסים</h3>
            <div class="grid2">
              <div>
                <label class="muted">שם פרס</label>
                <input id="newPrizeName" placeholder="למשל: ארטיק" />
              </div>
              <div>
                <label class="muted">מחיר בנקודות</label>
                <input id="newPrizeCost" type="number" min="0" placeholder="למשל: 20" />
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <button id="addPrizeBtn" class="btn ok">הוסף פרס</button>
            </div>

            <div class="divider"></div>

            <div class="muted">רשימת פרסים:</div>
            <div id="adminPrizeList" class="list" style="margin-top:10px"></div>
          </div>
        </div>

      </section>

      <aside class="card">
        <h2>הערות</h2>
        <p class="muted">
          הכניסה למנהל היא דרך <span class="k">הגדרות</span> בלבד.
          אין במסכים שום טקסט שמציג את הקוד.
        </p>
        <div class="divider"></div>
        <p class="note">
          NFC אמיתי (Web NFC) תלוי תמיכה במכשיר/דפדפן. תמיד אפשר לעבוד בסימולציה עם UID.
        </p>
      </aside>
    </main>
  </div>

<script>
  // הקוד לא מוצג בשום מקום ב-UI
  // קוד ברירת מחדל (ליצירת נתונים ראשוניים בלבד)
  const DEFAULT_ADMIN_CODE = "2590";

  const STORAGE_KEY = "nfc_kids_portal_v1";

  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return makeDefaultState();
    try{
      const s = JSON.parse(raw);
      s.kids ??= [];
      s.prizes ??= [];
      s.purchases ??= [];
      s.adminCodes ??= [DEFAULT_ADMIN_CODE];
      if(!Array.isArray(s.adminCodes) || s.adminCodes.length === 0) s.adminCodes = [DEFAULT_ADMIN_CODE];
      return s;
    }catch{
      return makeDefaultState();
    }
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state, null, 2));
  }

  function makeDefaultState(){
    return {
      adminCodes: [DEFAULT_ADMIN_CODE],
      kids: [
        { id: cryptoId(), name: "עילי", uid: "04DEMO0001", points: 50 },
        { id: cryptoId(), name: "דותן", uid: "04DEMO0002", points: 15 }
      ],
      prizes: [
        { id: cryptoId(), name: "ארטיק", cost: 20 },
        { id: cryptoId(), name: "שעת מסך", cost: 30 },
        { id: cryptoId(), name: "צעצוע קטן", cost: 60 }
      ],
      purchases: []
    };
  }

  function cryptoId(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  let state = loadState();

  const el = (id)=>document.getElementById(id);

  const screens = {
    home: el("homeScreen"),
    kidPortal: el("kidPortalScreen"),
    settings: el("settingsScreen"),
  };

  function showOnly(screenKey){
    Object.entries(screens).forEach(([k,node])=>{
      node.classList.toggle("hidden", k !== screenKey);
    });
  }

  function setModePill(text){ el("modePill").textContent = `מצב: ${text}`; }

  function setStatus(targetId, msg, kind=""){
    const node = el(targetId);
    node.textContent = msg;
    node.classList.remove("ok","bad");
    if(kind) node.classList.add(kind);
  }

  function renderKidsMiniList(){
    const box = el("kidsMiniList");
    box.innerHTML = "";
    if(state.kids.length === 0){
      box.innerHTML = `<div class="status bad">אין ילדים. הוסף בהגדרות.</div>`;
      return;
    }
    state.kids.slice(0,6).forEach(k=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div>
          <strong>${escapeHtml(k.name)}</strong>
          <div class="muted mono">${escapeHtml(k.uid)}</div>
        </div>
        <span class="badge">${k.points} נק׳</span>
      `;
      box.appendChild(div);
    });
  }

  function renderKidsAdminList(){
    const box = el("kidsAdminList");
    box.innerHTML = "";
    if(state.kids.length === 0){
      box.innerHTML = `<div class="status bad">אין ילדים עדיין.</div>`;
      return;
    }
    state.kids.forEach(k=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div>
          <strong>${escapeHtml(k.name)}</strong>
          <div class="muted mono">${escapeHtml(k.uid)}</div>
          <div class="muted">נקודות: ${k.points}</div>
        </div>
        <div class="row">
          <button class="btn danger" data-delkid="${k.id}">מחק</button>
        </div>
      `;
      box.appendChild(div);
    });

    box.querySelectorAll("[data-delkid]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-delkid");
        state.kids = state.kids.filter(k=>k.id !== id);
        state.purchases = state.purchases.filter(p=>p.kidId !== id);
        if(selectedKidId === id){
          selectedKidId = null;
          el("adminKidEditor").classList.add("hidden");
        }
        saveState();
        rerenderAll();
      });
    });
  }

  function renderAdminPrizeList(){
    const box = el("adminPrizeList");
    box.innerHTML = "";
    if(state.prizes.length === 0){
      box.innerHTML = `<div class="status bad">אין פרסים. הוסף למעלה.</div>`;
      return;
    }
    state.prizes.forEach(p=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div>
          <strong>${escapeHtml(p.name)}</strong>
          <div class="muted">מחיר: ${p.cost} נק׳</div>
        </div>
        <div class="row">
          <button class="btn danger" data-delprize="${p.id}">מחק</button>
        </div>
      `;
      box.appendChild(div);
    });

    box.querySelectorAll("[data-delprize]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-delprize");
        state.prizes = state.prizes.filter(p=>p.id !== id);
        saveState();
        rerenderAll();
      });
    });
  }

  function renderKidPortal(kid){
    el("kidNameTitle").textContent = kid.name;
    el("kidUidTitle").textContent = kid.uid;
    el("kidPoints").textContent = kid.points;

    const box = el("prizesStoreList");
    box.innerHTML = "";

    if(state.prizes.length === 0){
      box.innerHTML = `<div class="status bad">אין פרסים בחנות. מנהל צריך להוסיף.</div>`;
      return;
    }

    state.prizes.forEach(prize=>{
      const